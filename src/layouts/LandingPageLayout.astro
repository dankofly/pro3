---
import '~/assets/styles/tailwind.css';

import CommonMeta from '~/components/common/CommonMeta.astro';
import Favicons from '~/components/Favicons.astro';
import CustomStyles from '~/components/CustomStyles.astro';
import BasicScripts from '~/components/common/BasicScripts.astro';

import SEOHead from '~/components/landing/SEOHead.astro';
import LandingHeader from '~/components/landing/LandingHeader.astro';
import LandingFooter from '~/components/landing/LandingFooter.astro';
import StickyMobileBar from '~/components/landing/StickyMobileBar.astro';
import JsonLd from '~/components/landing/JsonLd.astro';

import type { Locale } from '~/i18n/utils';
import type { Dictionary } from '~/i18n/utils';

export interface Props {
  locale: Locale;
  currentPath: string;
  dict: Dictionary;
  ctaUrl: string;
  whatsappUrl: string;
  faqItems?: Array<{ question: string; answer: string }>;
}

const { locale, currentPath, dict, ctaUrl, whatsappUrl, faqItems } = Astro.props;
---

<!doctype html>
<html lang={locale} dir="ltr">
  <head>
    <CommonMeta />
    <Favicons />
    <CustomStyles />
    <title>{dict.meta.title}</title>
    <meta name="description" content={dict.meta.description} />
    <meta name="google-site-verification" content="Di_wPRAYuqUJA9c8uRB_nzCLsKp_tyNOJihO1OYYIq8" />
    <SEOHead
      locale={locale}
      currentPath={currentPath}
      title={dict.meta.title}
      description={dict.meta.description}
      ogTitle={dict.meta.ogTitle}
      ogDescription={dict.meta.ogDescription}
    />
  </head>

  <body class="antialiased text-slate-600 dark:text-slate-300 bg-white dark:bg-alpine-800 tracking-tight font-sans">
    <a href="#main-content" class="skip-to-content">Skip to content</a>
    <div class="scroll-progress" id="scroll-progress" aria-hidden="true"></div>

    <LandingHeader
      locale={locale}
      currentPath={currentPath}
      ctaUrl={ctaUrl}
      nav={dict.nav}
    />

    <main id="main-content" class="pb-16 md:pb-0">
      <slot />
    </main>

    <LandingFooter
      locale={locale}
      tagline={dict.footer.tagline}
      nav={dict.footer.nav}
      copyright={dict.footer.copyright}
    />

    <StickyMobileBar
      callLabel={dict.stickyBar.call}
      whatsappLabel={dict.stickyBar.whatsapp}
      requestLabel={dict.stickyBar.request}
      requestUrl={ctaUrl}
    />

    <JsonLd type="LocalBusiness" locale={locale} />
    <JsonLd type="TouristAttraction" locale={locale} />
    <JsonLd type="Service" locale={locale} />
    <JsonLd type="Person" locale={locale} />
    {faqItems && faqItems.length > 0 && (
      <JsonLd type="FAQPage" locale={locale} faqItems={faqItems} />
    )}

    <BasicScripts />

    <script is:inline>
      // Scroll progress bar + active nav section tracking
      (function() {
        var bar = document.getElementById('scroll-progress');
        var sections = document.querySelectorAll('section[id]');
        var navLinks = document.querySelectorAll('.nav-link-fancy');
        var ticking = false;

        function onScroll() {
          if (!ticking) {
            requestAnimationFrame(function() {
              // Progress bar
              if (bar) {
                var h = document.documentElement.scrollHeight - window.innerHeight;
                var pct = h > 0 ? (window.scrollY / h) * 100 : 0;
                bar.style.width = pct + '%';
              }
              // Active nav section
              var current = '';
              for (var i = 0; i < sections.length; i++) {
                var rect = sections[i].getBoundingClientRect();
                if (rect.top <= 120) current = sections[i].id;
              }
              for (var j = 0; j < navLinks.length; j++) {
                var href = navLinks[j].getAttribute('href');
                if (href === '#' + current) {
                  navLinks[j].classList.add('active');
                } else {
                  navLinks[j].classList.remove('active');
                }
              }
              ticking = false;
            });
            ticking = true;
          }
        }

        window.addEventListener('scroll', onScroll, { passive: true });
        onScroll();
      })();
    </script>

    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script is:inline>
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', function (user) {
          if (!user) {
            window.netlifyIdentity.on('login', function () {
              document.location.href = '/decapcms/';
            });
          }
        });
      }
      // Redirect confirmation tokens to the admin panel
      if (window.location.hash.includes('confirmation_token') ||
          window.location.hash.includes('invite_token') ||
          window.location.hash.includes('recovery_token')) {
        window.location.href = '/decapcms/' + window.location.hash;
      }
    </script>
  </body>
</html>
